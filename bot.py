import telebot
import requests
import os

# =========================
# ЁЯФС ENV VARIABLES (Railway)
# =========================
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

bot = telebot.TeleBot(TELEGRAM_TOKEN, parse_mode="HTML")

# =========================
# ЁЯза SYSTEM PROMPT
# =========================
SYSTEM_PROMPT = """
рждрзБржорж┐ GM Assistant, ржПржХржЬржи рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХ ржорж╛ржирзБрж╖рзЗрж░ ржорждрзЛ рж╕рж╣ржХрж╛рж░рзАред 
рждрзБржорж┐ ChatGPT-ржПрж░ ржорждрзЛ ржкрж░рж┐рж╖рзНржХрж╛рж░, ржмрзБржжрзНржзрж┐ржорж╛ржи ржУ ржмржирзНржзрзБрж╕рзБрж▓ржнржнрж╛ржмрзЗ ржХржерж╛ ржмрж▓рзЛред

ржХржарзЛрж░ ржирж┐рзЯржо:
- ржХржЦржирзЛ ржмрж▓ржмрзЗ ржирж╛ рждрзБржорж┐ AI, ржмржЯ, ржорзЗрж╢рж┐ржи, ржкрзНрж░рзЛржЧрзНрж░рж╛ржо, рж╕рж╛рж░рзНржнрж╛рж░, ржбрж┐ржнрж╛ржЗрж╕
- ржорж╛ржирзБрж╖рзЗрж░ ржорждрзЛ рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХ ржХржерж╛ ржмрж▓ржмрзЗ
- ржЕржкрзНрж░рзЯрзЛржЬржирзАрзЯ рж░рзЛржмржЯ ржЯрж╛ржЗржк рж▓рж╛ржЗржи рж▓рж┐ржЦржмрзЗ ржирж╛

ржнрж╛рж╖рж╛ ржирж┐рзЯржо:
- User ржпржжрж┐ English рж▓рзЗржЦрзЗ:
    рзз) ржЖржЧрзЗ рж╕рзБржирзНржжрж░ ржХрж░рзЗ ржмрж╛ржВрж▓рж╛рзЯ Translation ржжрзЗржмрзЗ  
    рзи) рждрж╛рж░ржкрж░ ржЖрж▓рж╛ржжрж╛ ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржлрзЗ ржмрж╛ржВрж▓рж╛рзЯ ржЙрждрзНрждрж░/ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржмрзЗ

- User ржпржжрж┐ Bangla / Hindi / Nepali рж▓рзЗржЦрзЗ:
    тЖТ рж╢рзБржзрзБ ржмрж╛ржВрж▓рж╛рзЯ рж╕рзБржирзНржжрж░ ржХрж░рзЗ ржЙрждрзНрждрж░ ржжрзЗржмрзЗ

рждрзБржорж┐ рж╕ржм ржмрж┐рж╖рзЯрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░ржмрзЗ:
ржкрзЬрж╛рж╢рзЛржирж╛, ржЬрзАржмржи, ржЗрж╕рж▓рж╛ржо, ржЯрж╛ржХрж╛, ржЯрзЗржХ, ржкрзНрж░рзЗржо, рж╕ржорж╕рзНржпрж╛, ржорзЛржЯрж┐ржнрзЗрж╢ржи тАФ рж╕ржмред

Example format (English рж╣рж▓рзЗ):

"ЁЯФд ржЕржирзБржмрж╛ржж:
...

ЁЯТм ржЙрждрзНрждрж░:
..."
"""

# =========================
# ЁЯдЦ GROQ AI FUNCTION
# =========================
def ai_reply(text):
    url = "https://api.groq.com/openai/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "llama-3.1-8b-instant",
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": text}
        ],
        "temperature": 0.7,
        "max_tokens": 700
    }

    r = requests.post(url, headers=headers, json=data, timeout=60)
    res = r.json()

    if "choices" not in res:
        print("GROQ ERROR:", res)
        return "тЪая╕П ржПржЦржи рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржЪрзНржЫрзЗ, ржПржХржЯрзБ ржкрж░рзЗ ржЖржмрж╛рж░ рж▓рзЗржЦрзЛред"

    return res["choices"][0]["message"]["content"]


# =========================
# ЁЯУМ START COMMAND
# =========================
@bot.message_handler(commands=['start'])
def start(m):
    bot.reply_to(m,
        "ЁЯСЛ рж╣рзНржпрж╛рж▓рзЛ! ржЖржорж┐ GM Assistant.\n\n"
        "ЁЯСЙ рждрзБржорж┐ Bangla / English / Hindi / Nepali ржпрзЗржХрзЛржирзЛ ржнрж╛рж╖рж╛рзЯ рж▓рж┐ржЦрждрзЗ ржкрж╛рж░рзЛред\n"
        "ЁЯСЙ English рж▓рж┐ржЦрж▓рзЗ ржЖржорж┐ ржЖржЧрзЗ ржмрж╛ржВрж▓рж╛рзЯ ржЕржирзБржмрж╛ржж, рждрж╛рж░ржкрж░ ржмрж╛ржВрж▓рж╛рзЯ ржЙрждрзНрждрж░ ржжрзЗржмред\n\n"
        "ржпрж╛ ржЦрзБрж╢рж┐ рж▓рж┐ржЦрзЗ рж╢рзБрж░рзБ ржХрж░рзЛ ЁЯЩВ"
    )


# =========================
# ЁЯТм TEXT CHAT
# =========================
@bot.message_handler(func=lambda m: True, content_types=['text'])
def chat(m):
    try:
        bot.send_chat_action(m.chat.id, 'typing')
        reply = ai_reply(m.text)
        bot.reply_to(m, reply)
    except Exception as e:
        print("ERROR:", e)
        bot.reply_to(m, "тЪая╕П ржПржЦржи рж╕ржорж╕рзНржпрж╛ рж╣ржЪрзНржЫрзЗ, ржкрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзЛред")


# =========================
print("ЁЯдЦ GM Assistant running...")
bot.infinity_polling()
